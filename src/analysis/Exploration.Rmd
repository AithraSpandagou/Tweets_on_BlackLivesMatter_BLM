---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

*Installing required packages*

```{r}

library(rtweet) 
library(tidyr)
library(ggplot.multistats)
library(ggplot2)
library(forestmangr)
library(syuzhet)
library(tidyverse)
library(readxl) # read excel
library(tibble) # tobble dataframe
library(stringr) # character manipulation
library(tidytext)
library(tokenizers)
library(stopwords)
library(lobstr)
library(glue)
library(dplyr) # piping

```
*Loading the data*

```{r}
blm_merged<-read.csv('../../gen/data-preparation/merging.csv', sep = ',', na.strings=c("", "NA"))

```

* set everything right * 
```{r}

# remove first column 
#blm_merged <- subset(blm_merged, select = -X)
#blm_merged <- subset(blm_merged, select = -row.names)

# set user_created_date as date
blm_merged$user_created_date <- as.Date(blm_merged$user_created_date, format = c("%Y-%m-%d"))

# Set date into as.Date
blm_merged$tweet_date <- as.Date(blm_merged$tweet_date )

```

*Making dataframe with amount of retweets, likes and replies*
To start some graphics we first need to make a dataframe inluding the amount of retweets, likes and replies. 

```{r}
#Retweet

RLR <- function(year){
    for (i in year){ 
      retweet <- (sum(blm_merged[blm_merged$year == year,]$retweet, na.rm = T))
      like <- (sum(blm_merged[blm_merged$year == year,]$like, na.rm = T))
      reply <- (sum(blm_merged[blm_merged$year == year,]$reply, na.rm = T))
      quoted <- (sum(blm_merged[blm_merged$year == year,]$quote_count, na.rm = T))
    } 
  RLRdata <- data.frame(category=c("Retweet", "Like", "Reply", "Quoted"), count = c(retweet, like, reply, quoted))
  return(RLRdata)
}

RLRdata2020 <- RLR(2020)
RLRdata2021 <- RLR(2021)

```




*Visualizing the data 2020*

By visualizing what kind of tweets are relatively most often used, we can directly see that the tweets of 2020 are most often liked compared to the replies, retweets and quoted tweets. A like represents that you like the post but do not repost it as retweets or quoted tweets do. 

```{r}
#Adding columns

RLRdata2020$fraction = RLRdata2020$count / sum(RLRdata2020$count)
RLRdata2020$percentage = RLRdata2020$count / sum(RLRdata2020$count) * 100
RLRdata2020$ymax = cumsum(RLRdata2020$fraction)
RLRdata2020$ymin = c(0, head(RLRdata2020$ymax, n=-1))

#Rounding up

RLRdata2020 <- round_df(RLRdata2020, 2)

# Specify what the legend should say
Type_of_Tweet <- paste(RLRdata2020$category, RLRdata2020$percentage, "%")

ggplot(RLRdata2020, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Type_of_Tweet)) +
  geom_rect() +
  coord_polar(theta="y") + 
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "right")
```
*Visualizing the data 2021*

For 2021 we do the same as before and see that there is a larger amount of retweets in proportion to the types of tweets compared to 2020. Apperantly users are argreeing more with tweets using the blm statements as they want to post the same. We also see that there is a larger amount of quoted tweets in proportion of all types of tweets (compared to 2020), this confirms the previous statement: people are agreeing more and want to speak about it. 

```{r}
#Adding columns

RLRdata2021$fraction = RLRdata2021$count / sum(RLRdata2021$count)
RLRdata2021$percentage = RLRdata2021$count / sum(RLRdata2021$count) * 100
RLRdata2021$ymax = cumsum(RLRdata2021$fraction)
RLRdata2021$ymin = c(0, head(RLRdata2021$ymax, n=-1))

#Rounding up

RLRdata2021 <- round_df(RLRdata2021, 2)

# Specify what the legend should say
Type_of_Tweet <- paste(RLRdata2021$category, RLRdata2021$percentage, "%")

ggplot(RLRdata2021, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Type_of_Tweet)) +
  geom_rect() +
  coord_polar(theta="y") + 
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "right")
```




*Most frequent words in the tweets*

Lets see which words are more frequently used in the posts of 2020.

First, we want to remove stop words like "so" and "at" for counting the most frequent words

```{r}

blm_merged$text <-  gsub("https\\S*", "", blm_merged$text)
blm_merged$text <-  gsub("@\\S*", "", blm_merged$text) 
blm_merged$text  <-  gsub("amp", "", blm_merged$text) 
blm_merged$text  <-  gsub("[\r\n]", "", blm_merged$text)
blm_merged$text  <-  gsub("[[:punct:]]", "", blm_merged$text)

tweets <- function(year){
  tweets2020 <- blm_merged[blm_merged$year == year,] %>% 
    select(text) %>%
    unnest_tokens(word, text)
  tweets2020 <- tweets2020 %>%
    anti_join(stop_words)
}

tweets(2020)
tweets(2021)
```


We want to see which word is most used in both years seperatly. For 2020 the most frequent word is blacklivesmatter, other most used words are "blm", "zwarte", "amsterdam" and "allivesmatter". 
For 2021 the most frequent word is blm (the abbreviation of blacklivesmatter), and other most used words are "blacklivesmatter", "antifa" and "mensen".

```{r}
#making a histogram

histogram_words <- function(year){
tweets(year) %>% 
  dplyr::count(word, sort = TRUE) %>%
  top_n(15) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  labs(y = "Count",
    x = "Unique words",
    title = "Most frequent words found in blm dataset",
    subtitle = "Stop words removed from the list")
}

histogram_words(2020)
histogram_words(2021)

```


*Sentiment analysis for positive or negative tweets 2020*

To see the nature of the tweets we can make a sentiment analysis. We do that for both years and see that in 2020 the negativity and positivity scores the highest. In 2021 we however see that the difference in sentiment scores is slightly bigger: it is more negative. We furthermore also see that in 2021 tweets score higher on disgust. That's a noticable difference! Apperantly people want to raise their voice in a more negative way in 2021.

```{r}

sentiment <- function(year){ 
  tweets_sentiment <- iconv(tweets(year), from="UTF-8", to="ASCII", sub="")# Converting tweets to ASCII to        trackle strange characters
  
  # removing retweets, in case needed 
  tweets_sentiment <-gsub("(RT|via)((?:\\b\\w*@\\w+)+)","",tweets_sentiment)
  
  # removing mentions, in case needed
  tweets_sentiment <-gsub("@\\w+","",tweets_sentiment)
  ew_sentiment<-get_nrc_sentiment((tweets_sentiment))
  sentimentscores<-data.frame(colSums(ew_sentiment[,]))
  names(sentimentscores) <- "Score"
  sentimentscores <- cbind("sentiment"=rownames(sentimentscores),sentimentscores)
  rownames(sentimentscores) <- NULL
  
  # make plot
  ggplot(data=sentimentscores,aes(x=sentiment,y=Score))+
    geom_bar(aes(fill=sentiment),stat = "identity")+
    theme(legend.position="none")+
    xlab("Sentiments")+ylab("Scores")+
    ggtitle("Total sentiment based on scores", year)+
    theme_minimal()
  
}
sentiment(2020)
sentiment(2021)

```


*Visualizing the variables in the dataset 2020*

We are now visalizing the likes by date for both years, as likes were most used compared to retweets and replies. We see that the most likes were in march of 2020. Additionally in 2021 that is the case for january. We, however, also see a large number of likes during february and march in 2021. We expected to see that approaching the elections of the Netherlands. 

```{r}
retweet_location <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
    geom_point(mapping = aes(x = like, y = date))
}
retweet_location(2020)
retweet_location(2021)
```

We now want to visualize the retweets by date for both years, as retweets were increasing by the years. When we check the plots, we see that as well. We see that a tweet is retweeted the most for 2020 in march, and for 2021 in january. We however expected that approaching the elections in the Netherlands (march 2021), tweets using the blm statements were more retweeted in March then in January to get the attention. 


```{r}
retweet_date <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
    geom_point(mapping = aes(x = retweet, y = date), color = "blue")
}

retweet_date(2020)
retweet_date(2021)

```

*Graphing users amount of followers and user amount friends*

We also want to check the relationship between the amount of followers and the amount of friends. There might be an relationship between the amount a user is following and the amount of followers of the user. We see that in general (for both years) users are following more other users than they have as followers.

```{r}
followers_friends <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
    geom_point(mapping = aes(x = user_amount_followers, y = user_amount_friends), color = "blue")
}

followers_friends(2020)
followers_friends(2021)
```

*Graphing users amount followers and source of tweet*

We want to check the relationship between the source of the tweet and the amount of user followers. As you might expect that when an user has a large number of followers, it needs to post more and an app might be more convient for that than using the webbrowser. For both years we see that the Twitter Web App and Twitter for iPhone are most used. For 2020 we see that users with the most amount of followers often use Twitter for Iphone. For 2021 we see however that TweetDeck is used for the user with the most amount of followers. We also see in 2021 that twitter for Android has been more used but that is probably due to the amount of tweets in 2021 compared to 2020. 

```{r}
time_source_tweet <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
    geom_point(mapping = aes(x = user_amount_followers, y = source_tweet), color = "blue")
}

time_source_tweet(2020)
time_source_tweet(2021)
```
#Filter if parties are mentioned in 2020

```{r}
names <- c("pvv|vvd|CDA|D66|GroenLinks|SP|PVDA|ChristenUnie|pvdd|50plus|DENK|FVD|BIJ1")

parties <- function(year){ 
  length(grep(names, blm_merged[blm_merged$year == 2020,]$text))
}

parties(2020)
```


```{r}

```
