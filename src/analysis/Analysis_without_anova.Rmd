---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
---
title: "BLM data analysis"
output: html_notebook
---

*Installing required packages*

```{r}
library(rtweet) 
library(tidyr)
library(ggplot.multistats)
library(ggplot2)
library(forestmangr)
library(syuzhet)
library(tidyverse)
library(readxl) # read excel
library(tibble) # tobble dataframe
library(dplyr) # piping
library(stringr) # character manipulation
library(tidytext)
library(tokenizers)
library(stopwords)
library(lobstr)
library(glue)

```
*Loading the data*

```{r}
blm_merged<-read.csv('../../gen/data-preparation/merging.csv', sep = ',', na.strings=c("", "NA"))

#blm2021<-read.csv('../../gen/data-preparation/temp/BLM2021_dataset.csv', sep = '', na.strings=c("", "NA"))
```


*Making dataframe with amount of retweets, likes and replies*

```{r}
#Retweet

RLR <- function(year){
    for (i in year){ 
      retweet <- (sum(blm_merged[blm_merged$year == year,]$retweet, na.rm = T))
      like <- (sum(blm_merged[blm_merged$year == year,]$like, na.rm = T))
      reply <- (sum(blm_merged[blm_merged$year == year,]$reply, na.rm = T))
    } 
  RLRdata <- data.frame(category=c("Retweet", "Like", "Reply"), count = c(retweet, like, reply))
  return(RLRdata)
}

RLRdata2020 <- RLR(2020)
RLRdata2020
RLRdata2021 <- RLR(2021)
RLRdata2021

```




*Visualizing the data 2020*

```{r}
#Adding columns

RLRdata2020$fraction = RLRdata2020$count / sum(RLRdata2020$count)
RLRdata2020$percentage = RLRdata2020$count / sum(RLRdata2020$count) * 100
RLRdata2020$ymax = cumsum(RLRdata2020$fraction)
RLRdata2020$ymin = c(0, head(RLRdata2020$ymax, n=-1))

#Rounding up

RLRdata2020 <- round_df(RLRdata2020, 2)

# Specify what the legend should say
Type_of_Tweet <- paste(RLRdata2020$category, RLRdata2020$percentage, "%")

ggplot(RLRdata2020, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Type_of_Tweet)) +
  geom_rect() +
  coord_polar(theta="y") + 
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "right")



```
*Visualizing the data 2021*
```{r}
#Adding columns

RLRdata2021$fraction = RLRdata2021$count / sum(RLRdata2021$count)
RLRdata2021$percentage = RLRdata2021$count / sum(RLRdata2021$count) * 100
RLRdata2021$ymax = cumsum(RLRdata2021$fraction)
RLRdata2021$ymin = c(0, head(RLRdata2021$ymax, n=-1))

#Rounding up

RLRdata2021 <- round_df(RLRdata2021, 2)

# Specify what the legend should say
Type_of_Tweet <- paste(RLRdata2021$category, RLRdata2021$percentage, "%")

ggplot(RLRdata2021, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Type_of_Tweet)) +
  geom_rect() +
  coord_polar(theta="y") + 
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "right")
```




*Most frequent words in the tweets*

Lets see which words are more frequently used in the posts of 2020

First, we want to remove stop words like "so" and "at" for counting the most frequent words

```{r}
tweets <- function(year){ 
  tweets <- blm_merged[blm_merged$year == year,] %>%
  select(text) %>%
  unnest_tokens(word, text)
tweets <- tweets %>%
  anti_join(get_stopwords(language = "nl", source = "snowball"))
}
tweets(2020)
tweets(2021)
```
We want to see which word is most used in both years seperatly. For 2020 the most frequent word is blacklivesmatter, other most used words are "blm", "zwarte", "amsterdam" and "allivesmatter". 
For 2021 the most frequent word is blm (the abbreviation of blacklivesmatter), and other most used words are "blacklivesmatter", "antifa" and "mensen".

```{r}
#making a histogram
histogram_tweets <- function(year){
  tweets(year) %>% # gives you a bar chart of the most frequent words found in the tweets
  count(word, sort = TRUE) %>%
  top_n(15) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  labs(y = "Count",
       x = "Unique words",
       title = "Most frequent words found in the tweets of #BLM",
       subtitle = "Stop words removed from the list")
}

histogram_tweets(2020)
histogram_tweets(2021)
```


*Sentiment analysis for positive or negative tweets 2020*

To see the nature of the tweets we can make a sentiment analysis. We do that for both years again and see that in 2020 the positivity scores the highest. In 2021 we however see that the sentiment scores the highest in negative. That's a noticable difference!

```{r}

sentiment <- function(year){ 
  tweets_sentiment <- iconv(tweets(year), from="UTF-8", to="ASCII", sub="")# Converting tweets to ASCII to trackle strange characters

  # removing retweets, in case needed 
  tweets_sentiment <-gsub("(RT|via)((?:\\b\\w*@\\w+)+)","",tweets_sentiment)

  # removing mentions, in case needed
  tweets_sentiment <-gsub("@\\w+","",tweets_sentiment)
  ew_sentiment<-get_nrc_sentiment((tweets_sentiment))
  sentimentscores<-data.frame(colSums(ew_sentiment[,]))
  names(sentimentscores) <- "Score"
  sentimentscores <- cbind("sentiment"=rownames(sentimentscores),sentimentscores)
  rownames(sentimentscores) <- NULL
  
  # make plot
  ggplot(data=sentimentscores,aes(x=sentiment,y=Score))+
    geom_bar(aes(fill=sentiment),stat = "identity")+
    theme(legend.position="none")+
    xlab("Sentiments")+ylab("Scores")+
    ggtitle("Total sentiment based on scores 2020")+
    theme_minimal()
  
  }
sentiment(2020)
sentiment(2021)

```


*Visualizing the variables in the dataset 2020*

We now want to visualize retweets by location. 

```{r}
retweet_location <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
  geom_point(mapping = aes(x = retweet, y = location))
  }
retweet_location(2020)
retweet_location(2021)
```

We now want to visualize the retweet by date for both years.

```{r}
retweet_date <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
  geom_point(mapping = aes(x = retweet, y = date), color = "blue")
}

retweet_date(2020)
retweet_date(2021)

```
*Graphing users amount of followers and user amount friends*
We also want to visualize the relationship between the amount of followers and the amount of friens. 

```{r}
followers_friends <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
  geom_point(mapping = aes(x = user_amount_followers, y = user_amount_friends), color = "blue")
}

followers_friends(2020)
followers_friends(2021)
```

*Graphing users amount status by location*

```{r}
status_location <- function(year){ 
  ggplot(data = blm_merged[blm_merged$year == year,]) + 
  geom_point(mapping = aes(x = user_amount_status, y = location), color = "blue")
}

status_location(2020)
status_location(2021)
```
#Filter if parties are mentioned in 2020

```{r}
state.name[grep ("VVD", "PvdA", "PVV", "CDA", "SP", "CU", "PvdD", state.name)]
```


```
